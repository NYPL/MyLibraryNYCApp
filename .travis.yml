language: ruby
  # 2020-08-04: caching significantly reduces build time in travis,
  # but we're currently having issues with obtaining correct cached rvm
  # cache:
  #   bundler: true
  #   directories:
  #   - "/home/travis/.rvm/"
rvm:
- 2.5.7
before_install:
  # 2019-10-16: added to fix errors when upgrading rails env
  # 2020-08-04: removed to fix errors with travis deployment -- 
  # looks like travis internal rvm handling has changed
  # - rvm use 2.5.7 --install --binary --fuzzy
- gem --version
- gem install bundler -v '< 2'  # helps with compatibility issues when upgrading to rails 5
- bundle config --global github.https true
before_script:
- bundle exec rubocop
services:
- postgresql
script:
- bundle install
- psql -c "CREATE DATABASE mln_test;" -U postgres
# recreate test database from db/schema.rb
- bundle exec rake db:schema:load RAILS_ENV=test
# helps travis update its test db.  seems the schema load below doesn't always do it.
- bundle exec rake db:migrate RAILS_ENV=test
# - bundle exec rake db:test:prepare  # NOTE: might need this later.
- bundle exec rake combined_tests:test
deploy:
- provider: elasticbeanstalk
  skip_cleanup: true
  access_key_id: "$AWS_ACCESS_KEY_ID_DEVELOPMENT"
  secret_access_key: "$AWS_SECRET_ACCESS_KEY_DEVELOPMENT"
  region: us-east-1
  app: my-library-nyc-app
  env: my-library-nyc-app-dev-1002
  bucket_name: elasticbeanstalk-us-east-1-224280085904
  bucket_path: my-library-nyc-app-dev-1002
  on:
    repo: NYPL/MyLibraryNYCApp
    branch: development
- provider: elasticbeanstalk
  skip_cleanup: true
  access_key_id: "$AWS_ACCESS_KEY_ID_QA"
  secret_access_key: "$AWS_SECRET_ACCESS_KEY_QA"
  region: us-east-1
  app: my-library-nyc-app
  env: my-library-nyc-app-qa25
  bucket_name: elasticbeanstalk-us-east-1-946183545209
  bucket_path: my-library-nyc-app-qa
  on:
    repo: NYPL/MyLibraryNYCApp
    branch: qa
- provider: elasticbeanstalk
  skip_cleanup: true
  access_key_id: "$AWS_ACCESS_KEY_ID_PRODUCTION"
  secret_access_key: "$AWS_SECRET_ACCESS_KEY_PRODUCTION"
  region: us-east-1
  app: my-library-nyc-app
  env: my-library-nyc-app-production
  bucket_name: elasticbeanstalk-us-east-1-946183545209
  bucket_path: my-library-nyc-app-production
  on:
    repo: NYPL/MyLibraryNYCApp
    branch: master
env:
  global:
  - secure: qG6U01b93MR63UaRYrRYDJ0cSgannMLAGsEmalgvbOWWsoM8jGpgwfaxi2wPlN07t9zoF81M0qp4MsISxe8e9E/INJz1lR4HKdXjcRlM+snBr2PL+2siPHnxtYMil5TNFPwpGoQxy9VzeWvrrHEGHq0PsRD0muv3BaJzS8gFojCEJSK0YDk/Xi53LkWshSR0tEgXzZJnkh8Q+ObA8KjttwJgUZ8u8BILWyK+axRQlbAwGEzilVm9ZlLJghFQI7xIit+hJMU2UTUifN1WkmFL7Ko4HZTUK/CntWRPeuPKlf4FuvH0PKnuZRPF8laVgcjFhDo4T43nMgGcL59qyk6FoTFacg50bpZiijqqUdJa3NEWw2oxhVCkfDJY92pDOlVfVJTMzLMHKc2ByxmYc8uUQ0yppOBIS9U+gKUofiXTbzZ8ZrMZ9up15H8NBYW3ryHUQ2fhf+LSUlyDJ4F3bl97Toy818IuDA5A3B1eW09DTDX9n9nkQxbh0Udd91QIj/c512Qtn9Ddql7OuprHZOC8qsJeVF5yDLqb+kY2WWR/mYvPnTcoDU7v/3u7mPdIBTgcGqh4+kuxH82V15AuMQ45g+toORCeEe4GDrHZ7vsO5ai8IKijqUWwM7DxaZ+mXqbXbmqwfdfoDjaOyUpJ9bWkNp6mimQ66m1mnk4BWzp7cn8=
  - secure: zv3xDzLUXShwlfq8c5paUGDPLpeYFHq/YZYHKoxiRiJyYBACjcM7hLEtNUSZqe9dQhons2IEsFzS+Qr1ON32MBTFJp7X0KPxPe19YsEaEH01/NaZGbeC7Vq8vW+OT11c6Sbh9XbecU9qSeBCpID/i5Yb78oDEgqK8D0kxjNutWz3F5iDzX3PXqucTR2qNPW8s6mA5Q3Qea+8KoX5/ykV8Yx7Kx+GsSdQhSYzd/1DOuaNXQskCwlDyfdj1c2xNXmq1y7YiVdrMO1SsRPPCSfqs356j6hyEzFOd/lmk0y98+FyT6y3hA+/SdjAxMp4BRlvrLyqlAQIvi18mSkAcoU2mXJSI4XoVqbw06pCbKc0NcyKpz55xVm5FN+4UBvY/rcQK0cRFQEkE8xnMl7z/sacz/hlFNduiq5feXHxLno+suXHLp0KmFgpsZx1cqpkCcm5RO1bsv97Az4hrEfWeaIRTSIMXXru0gPipwv9aAUQTxuYuI5xsCP+Sklr/gjBA1ow0+rL+DweCu9R/DJ+ViaJJoVOxVWMHHJqidDHvIqB/49vHdevIHuj9MNj0sbsD0jxxx0Q3Drb/RkBCuGKDVvWiCeShVSddsiL5Ejsy59BABqBq0Y8qQJxDi8pOcMGtY4rJJXhgyBSIZmfnmqDM7kFoXw+Xv52FvgR8WaQctEEdW8=
  - secure: OAgZCBrecXRyKN1xEAUt3e9Q4Dtsy0COMoafdnryei2WrlOcidRd5qdKcvG0x6fjjIux+p5c+kMA2yPFybwmfbB0/MAPwgektI9Aa8GXSJHzOEqPde8DsmqQ517BRyaN7MmK1BRYfBbMW+EwSDaJWSaoOl+2vVGIGdzm8WYP+R3n8GNFH5OTc9bPB6X3hZ2KojxzcUvKTQXhywJG3PkNvCGGpsymfNkSn20q+yOwtU6AVBL60RzKCMz9+Sk65FUss89SoRygHJOJxy1MFW3NaHU0V5npffMoVexNb339jRDehnq6TOlgRR9bcr8BrqFY9uctmJ78hrsaLgbgXZI+2IN3/rME8nWoxsU1FQZb59mIGEq/yYT5kr2SRLwFu79DmgqPw/U7cf2P+LG66kBQFJBVjCwPcMA7R58yiWOuxp/Iejj9UdtScMCZ8mc73oeLnPu9L0nRF8g8OMwaM1cjGHmEsNktsZY5skc83sXtrq1sRHVXemA2cM6y62Yqa8MkOgoq752kla8IvsLscJgdAD1DWwLf5u1/1COHrCbFVaGFMc1zkDuyNfFjMf2Wp00mpzTQbuTx7sspxEe7rn3RS6TtQUHOMqS5ICU/mi07YBJGPHFgOZhfEs6UIF3qs7HbPFPP2ChYG5j2ThaZztMBPBzE+qnpdDGsIt8a5Ekweyo=
