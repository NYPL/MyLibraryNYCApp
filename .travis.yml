language: ruby
cache:
  bundler: true
  directories:
  - "/home/travis/.rvm/"
rvm:
- 2.5.7
before_install:
- rvm use 2.5.7 --install --binary --fuzzy  # 2019-10-16: added to fix errors when upgrading rails env
- gem --version
- gem install bundler -v '< 2'  # 2019-10-16: added to fix errors when upgrading rails env
- bundle config --global github.https true  # 2019-10-16: added to fix errors when upgrading rails env
before_script:
- bundle exec rubocop
services:
- postgresql
script:
- bundle install
- psql -c "CREATE DATABASE mln_test;" -U postgres
# - bundle exec rake db:migrate RAILS_ENV=test # 2019-10-16: added to fix errors when upgrading rails env
# - bundle exec rake db:migrate
# recreate test database from db/schema.rb
- bundle exec rake db:schema:load
# - bundle exec rake db:test:prepare  # NOTE: might need this later.
- bundle exec rake combined_tests:test
deploy:
- provider: elasticbeanstalk
  skip_cleanup: true
  access_key_id: "$AWS_ACCESS_KEY_ID_DEVELOPMENT"
  secret_access_key: "$AWS_SECRET_ACCESS_KEY_DEVELOPMENT"
  region: us-east-1
  app: my-library-nyc-app
  env: my-library-nyc-app-dev-1002
  bucket_name: elasticbeanstalk-us-east-1-224280085904
  bucket_path: my-library-nyc-app-dev-1002
  on:
    repo: NYPL/MyLibraryNYCApp
    branch: development
- provider: elasticbeanstalk
  skip_cleanup: true
  access_key_id: "$AWS_ACCESS_KEY_ID_QA"
  secret_access_key: "$AWS_SECRET_ACCESS_KEY_QA"
  region: us-east-1
  app: my-library-nyc-app
  env: my-library-nyc-app-qa25
  bucket_name: elasticbeanstalk-us-east-1-946183545209
  bucket_path: my-library-nyc-app-qa
  on:
    repo: NYPL/MyLibraryNYCApp
    branch: qa
- provider: elasticbeanstalk
  skip_cleanup: true
  access_key_id: "$AWS_ACCESS_KEY_ID_PRODUCTION"
  secret_access_key: "$AWS_SECRET_ACCESS_KEY_PRODUCTION"
  region: us-east-1
  app: my-library-nyc-app
  env: my-library-nyc-app-production25
  bucket_name: elasticbeanstalk-us-east-1-946183545209
  bucket_path: my-library-nyc-app-production25
  on:
    repo: NYPL/MyLibraryNYCApp
    branch: master
env:
  global:
  #- secure: kU22NeR5MRu32K3YzAImTzC0G9Bzg2kIJ2PBtGkmlgWzWlhI54uqW/euTnOZc/1+0/9oYRv4uGavRWLdlO1oYJmGv09nYseLZJJzGP+QAxHptT9AlOt60q+m/FgkgunfGPF8NHiVSHYk30N79k7t1sKTEc2lcFTt2fAb8vDSwmA8HM1/gb22HaNFuCWolMG1AKQVNZ0bWLB1IM6cvIoWC0/R8jEvNYNlgfQkGzWGcnbtJmqlOeMsy3v4WMBzkMr8bdem07dGU6R6siJ3uvQMVwTYzpB/Qtgy1nXnnasZp5zaJxJYHM9O1sXnz+xy4DroGpHj0lkacKhoBP2Vg0U3eVSf/d+LE2yt0xD17vjXmwB027uvdUvsmRTto1BdjwPKxkes6wyjvYLp/Z8TJbnUNS716ZVSvY8ublCLTZERBleYB8ACQaRHJ3zJMvngi6tIOz5G0K5Xzl+8tpC4iAKNdRkBaMKGjLvlEJQsFC/6p9mCPipCx94Lgww6yzgSe6Yog0P9mv6JPJlUrlGNYP+Zit+e/nnjq71Iw/gteWwTZ3kWXRs0/jm4PnnbgY2h0oELJI2CGYP2Q3FaxuP9rhCtgRvwg8GI8ayvtb0CU3DTxQ4GtlsnSi//j+8HpRx1fpY9zv5GSUHradZ0R4kUD8MxHxAZ0a59kJyKEL1NILakuNc=
  #- secure: AlqiHimc/EV+vH/PMnwdjiTqK4OC9zrnLvcLSW3fSrwL/RILZl2Sw+JYjvdLulPGyLmpycb5y4v6b1+hkVStnGUmdWxO2TZqDhHGph/PGvxwCNHnltbRihZxEBB2cYwWQunmN/6pcGx6oQkqy88j1yOFudpU5H2JAVoeZMCNBtstGamFpQtwHWwtiAU4AUMbMN0KC9Lo13evLFzsQRUhquTcK63qntfpVeXwqNNq9mlR6FmMgC/mBzXp0G/Wu3YqLqVQZqSbpwXCINFczFKHHvaxxkq7FtewKkjMCdSUHmnGA6Ht9UcLah7F98PWwf/XAFKGPT35xpZxGAgbU8dfMBQ7izhERRLMpa5QGzcWkTkuerTTMNFg3VynPuezhQmY3XH3sJtlMyLq4qsvkwXoUl20QizJE3IaEQPsannUCKvfhBCl8d+vbU/MmY/LL+RSQvEoHvgIADa8trNGQz26EVrMe/pFqYHnjb5AjPbEk+WdnzS1qTiN1H7x6hP5HF6DSdv759pXfi0vVKWHB53m5Jm7G7hPxvwvk3h7DVNTibM5e/JUzoBR+MzuUEz1E5YFHZ39ScnSiM+Ep7Tf1OvE43gtN3BPJiVc0IDXQY63shc+Cr1Xo2ipx8F0wDIRguCEiOTG9eH0oVPseUQnHcpPwIeXxhVew/bXL8+B9JEzqk4=
  #- secure: TiDpCtWxc5c9LvglbV6lqTZ/ziQhSuGdhUz2UdTi4kAJz3+HSMa08dXFVFw0/HGF6U+w/Z9FHvkU93p5G+jURcvpRkpz8yGTyT8zOgCF1dPVO3fjYgl+qZfKwYI2FshhaktbMQXVy8dqMekOuxwJgQuACCUuQ0cIqCr1KhBeOQErJgjL3mLWNttaEqoeJvPFYITzSQQMJCo/aYG1UDDfI6AjBymUIWTTqYdJMPAHk7eN4FgOaCcjo/f9DeLmJ8MwkF8T5yMTqEePbutgqL2E+4Wc1ZmPCVrUExAGjyuWxCHZIoc2YL0TIjvm7KiIzo8TsfniA4RGK1f9f+k2My0eq00kECVIQxCYHfTffUrDR1JzHzXseK1h1CUPY6k7LOBuYP9Dbt/yAk/LKZz1jVQYBd9t/ODaSKZrRVoMh9aIOtPG86uMkKx+Le50juECklTO2xJyQp+eCu7VTFAnSwR0Z/Np6q0j9Bm5SPK/5dtz/cDM9+HS+bC8R93kVXD3YmXJgOEi7vD/ADoaoLpvk02uqsTM0LkVVvlfI+YjQf1Sv9Ew/Z33Q+3AHe89hj9MHXzU+lyqKw6vu0tsdxsF66ZUUQzSIlbgyEW09HIjMNpWZkM0Rwi8kRe0r21703j21leEtEuxtpCnImweI8gChoy8vVvf6PburHkb6xKwW45SS7I=
  - secure: OoSnnbYpSGc0nVNPM7GKdx6qgWQGqQdmRP7oOP+OKx3eUfc7CgJPtV515lwKYXtoQ67UqHt/Nc2lX8ofjARhuCBHC2j7CtmJLcHjxB+GBTTVmw8xOyaS1Q17S+tRJc0KHHtTAYrOAn/nvmpJt8fvnfWzx30mLhpApo4dUfyaLYxkz4gP6/qLyyGuqIlNse5x5EQR1Mes21ym8neiZsiZkQocM5Oecq2jRZiBJkzvuw2wPUxlshL/be7uS4YW6HEFOzfuJmtI8J5ZskbAN0hqcmF9WeaPRqSIgJ5Lc/PcpiFbtNVHr2GYGr8qNi+X5JjLkEjAK38a3zJ1AhNbMQZj7G8F8EGHFKbBuiJUIWvyaJdoyRnfLVTXBSTxfSt2k3bVMVgy76j0OyvQZN0wpW2fl6W8mVyCxUJIpYJtJO2JYYqKDSSr6x34FHjdGUeURwFwjtgnhA6zc5DOq7KcQfFKuwZ0QUeEUYsqzLpifr2tjjgnhtKQuwXmerJJR6YYsizkvs9zIgomVLdtnnWQeQQmRNsoH7X0mG+8iQQb5fRQ0q2z85gc+5rmxjj94CTiGydyCu8E7f2Dp+zUV1g+Ilw7YSbqVpDTyc/I0vdygWyUYIC9PeUJkYBss1giS3+1Oq2saFrbhAktyB2ovNyH3EY4Zp8Sq7SmDeyjRx9xs5YsODg=
  - secure: oJmVcNLvop6YDExulyr23CkVhcaKL4LqED5ywSXFVdGqG9CT5uXznStulqkVLPLiL9H4PpPHfrALvC2e7W0eEqPnsBrfiN3mm+iR/8MBkz6BRftfirceS/uthkkcEIrVpOLSC/hVbrdZFG3/Fn8ILtJilhwuLWTvUHG3O1iRXf5kbrcVWkEvsj8Crsm5ceNyc0n/oA6S/gWgU86nT3SmVJj0xfdai1r+lOfHHC6GORPtIfho8ZlVDjvPQKMiJb6pogUqvROocXaA0O0H+4QZlGfZN9g2YWYNloKbm4ynCsBaQlkbBY/0zkYGGpzb8geMCo401JBDJLkkxSdL7QE7g0+GnxoSjoS4tk9jwZnhKlj5N7ZWx6HeAF6ety6YAJIGaMdTNpD+mlJa60ypAn+kZwpP9mGuA66etrotJUkMFhlB9eEPVAvkKS/bzajvg0M0BDFO28W3XX/2Z8JwOBRQJcGyNUIRGa82hqySDmSCbh28kNjTR8nwpnfMXm29y4lIZdqY6fhgCuc4aetqEEAGAsaNA0SAQaf8i30Bsq7t0wJ1wfWvre/3xK8FpywuEXuwLOOrbJZ/S/yMZSbbr9ZhFRL9pmgC4HNWPj7W1Mu9MCJ5SuXGg/1z6jklYS1UJrAFqgUiVaLxYv+7/VBlhN5XYwCmg+IN+9vtR4PZFvnPyCI=
  - secure: JykdJlLDlFMcs7J9CPoH0P8eXYlF2/Cr6+y8G83SnBZga/iz4pvPcBK0CNT0O0WiZ+c+23NDnX2xkfRVchmJ9yGUzjJe9ENtf2UYeNW1IccpuSrtxzjgoxcoE0vhMckyjnNuXKGQX6W7sw1DqPLP/6HNTkI8xBeVnKKwt/UFnDZLJthq2xbDx0dgsQm5Mi+6ZA9fFIeLaMcriF9YliPSCMygWUsW2r1Eb/DkLUZ48V/qYD11YeTeUC8o439vAhhpix+0QEbdfG0NIl4qm1lFPOeX66jnP4XKI3JV0brR1ep420vpNVP7oVGKdBHk0DSVi90JlfLOxpbYcxMIg4xtIKVf77JVLmulx4VapqohnlIGsfxiU2iO/7d2iOAN27h+MgQeklMOV3v7LlR0rd0ciRWKV7k307I2yrVfbQAbYE7MfRXxNWDuhwkUIzUV7LZZTKSvOMQEJP99YR5a4Pjjdlda9QhRHCMLnYeyPK3k5FmOGxNNfadgv/AemFCTlnYnF0ma9DGp/FN04mHhLRTJVHQ4ssBuKFUqCFvsVY0NVjBZqCVetd7l3odG3dXDe44yAWUIUCvtPwq5qPcSmO1Up4ssaQzjdFPEFVnRpMK5ZUoKixCFPzfK+Sgdd/RgyIQjS2ypedKyJs0hFtz20D5haJ6Jugi/rstoUeHFvZ7BzN8=
