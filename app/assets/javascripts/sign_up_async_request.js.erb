$( document ).ready(function() {

	$('#user_email').on('focusout', function(){

		$("#sign_up_button").prop("disabled",true);
		$("#sign_up_button").css("background-color","grey");
		$(".spinner").css("display","block");
		$("#check_email_div").css("display","block")
		$("#check_email_span").text("Validating email: " + $(this).val());
		$("#check_email_span").css({"margin-left":"30px","color":"black"});

		 validateEmailFormat($('#user_email').val());
		 validateEmailDomain($('#user_email').val());

		$.ajax({
			url: window.location.origin + "/check_email",
			type: "GET",
			data:{
				email: $('#user_email').val()
			},
			success:function(result,options,thrownError){

				if (result.statusCode == 200) {

					$(".spinner").css("display","none");
					$("#check_email_span").css({"margin-left":"0px","color": "red"})
					$("#check_email_span").text("An account is already registered to this email address. Contact help@mylibrarynyc.org if you need assistance.");
				}

				if (result.statusCode == 404) {

					$(".spinner").css("display","none");

					$("#check_email_span").css({"margin-left":"0px","color":'green'})
					$("#check_email_span").text("Success! We've confirmed that you don't already have a MyLibraryNYC account."); 

					$("#sign_up_button").prop("disabled",false);
					$("#sign_up_button").css("background-color","#af2228")

					$("#sign_up_button").hover(function(){
						$(this).css("opacity", 0.9);
					}, function() {
						$(this).css("opacity", 1.0);
					})
				}

				if (result.statusCode != 200 && result.statusCode != 404) {

					handleError();
				}

			},
			error:function(result,options, thrownError){

				handleError();

			}
		})
})

function handleError(){

	$(".spinner").css("display","none");
	$("#check_email_span").css({"margin-left":"0px","color": "red"})
	$("#check_email_span").text("We've encountered an error. Please try again later or email help@mylibrarynyc.org for assistance.");
}

function validateEmailFormat(email) {
	var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]     {1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
	if(re.test(email) == false){
		$(".spinner").css("display","none");
		$('#check_email_div').css("display","none");

		throw new InvalidEmailFormatError("Invalid e-mail-format");
	}
}

function validateEmailDomain(email){
	var domain = email.split('@')
	if(domain[1] != "schools.nyc.gov"){
		$(".spinner").css("display","none");
	    $('#check_email_div').css("display","none");
		throw new InvalidEmailDomainError("Invalid e-mail domain")
	}
}



window.ClientSideValidations.callbacks.element.fail = function(element, message, callback) {
	callback();
	$(element).css('background', '#f6d6d8');
	$(element).css('border','0.0625rem #97272c solid');
	if(element[0].name == 'user[email]'){
		$($("[for=user_email]")[1]).text('Enter a valid email address ending in "@schools.nyc.gov".')

	}
}

window.ClientSideValidations.callbacks.element.pass = function(element, callback) {
	$(element).css('background', '#E8E4E2');
	$(element).css('border','1px solid #D0CDC8');
	callback()
}




})	