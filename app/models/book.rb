EXAMPLE_RESPONSE_BODY_FROM_BIB_SERVICE = {
  "data": [
    {
      "id": "20054679",
      "nyplSource": "sierra-nypl",
      "nyplType": "bib",
      "updatedDate": "2018-10-16T21:13:30-04:00",
      "createdDate": "2014-03-11T19:58:51-04:00",
      "deletedDate": nil,
      "deleted": false,
      "locations": [
        {
          "code": "agj",
          "name": "Aguilar Children "
        },
        {
          "code": "bcj",
          "name": "Bronx Library Center Children"
        },
        {
          "code": "ctj",
          "name": "Castle Hill Children"
        },
        {
          "code": "hgj",
          "name": "Hamilton Grange Children"
        },
        {
          "code": "hpj",
          "name": "Hudson Park Children"
        },
        {
          "code": "htj",
          "name": "Countee Cullen Children"
        },
        {
          "code": "inj",
          "name": "Inwood Children"
        },
        {
          "code": "lmj",
          "name": "New Amsterdam Children"
        },
        {
          "code": "mpj",
          "name": "Morris Park Children"
        },
        {
          "code": "nbj",
          "name": "West New Brighton Children"
        },
        {
          "code": "pkj",
          "name": "Parkchester Children"
        },
        {
          "code": "pmj",
          "name": "Pelham Bay Children"
        },
        {
          "code": "rij",
          "name": "Roosevelt Island Children"
        },
        {
          "code": "sbj",
          "name": "South Beach Children"
        },
        {
          "code": "tmj",
          "name": "Tremont Children"
        },
        {
          "code": "wbj",
          "name": "Webster Children"
        },
        {
          "code": "wkj",
          "name": "Wakefield Children"
        },
        {
          "code": "wtj",
          "name": "Westchester Square Children"
        },
        {
          "code": "mal",
          "name": "SASB - Service Desk Rm 315"
        },
        {
          "code": "ccj",
          "name": "SASB - Children's Center Rm 84"
        }
      ],
      "suppressed": false,
      "lang": {
        "code": "eng",
        "name": "English"
      },
      "title": "Little Roja Riding Hood",
      "author": "Elya, Susan Middleton, 1955-",
      "materialType": {
        "code": "a",
        "value": "BOOK/TEXT"
      },
      "bibLevel": {
        "code": "m",
        "value": "MONOGRAPH"
      },
      "publishYear": 2014,
      "catalogDate": "2014-04-16",
      "country": {
        "code": "nyu",
        "name": "New York (State)"
      },
      "normTitle": "little roja riding hood",
      "normAuthor": "elya susan middleton 1955",
      "standardNumbers": [
        "9780399247675",
        "039924767X"
      ],
      "controlNumber": "799250948",
      "fixedFields": {
        "24": {
          "label": "Language",
          "value": "eng",
          "display": "English"
        },
        "25": {
          "label": "Skip",
          "value": "0",
          "display": nil
        },
        "26": {
          "label": "Location",
          "value": "multi",
          "display": nil
        },
        "27": {
          "label": "COPIES",
          "value": "22",
          "display": nil
        },
        "28": {
          "label": "Cat. Date",
          "value": "2014-04-16",
          "display": nil
        },
        "29": {
          "label": "Bib Level",
          "value": "m",
          "display": "MONOGRAPH"
        },
        "30": {
          "label": "Material Type",
          "value": "a",
          "display": "BOOK/TEXT"
        },
        "31": {
          "label": "Bib Code 3",
          "value": "-",
          "display": nil
        },
        "80": {
          "label": "Record Type",
          "value": "b",
          "display": nil
        },
        "81": {
          "label": "Record Number",
          "value": "20054679",
          "display": nil
        },
        "83": {
          "label": "Created Date",
          "value": "2014-03-11T19:58:51Z",
          "display": nil
        },
        "84": {
          "label": "Updated Date",
          "value": "2018-10-16T21:13:30Z",
          "display": nil
        },
        "85": {
          "label": "No. of Revisions",
          "value": "193",
          "display": nil
        },
        "86": {
          "label": "Agency",
          "value": "1",
          "display": nil
        },
        "89": {
          "label": "Country",
          "value": "nyu",
          "display": "New York (State)"
        },
        "98": {
          "label": "PDATE",
          "value": "2018-08-14T15:33:07Z",
          "display": nil
        },
        "107": {
          "label": "MARC Type",
          "value": " ",
          "display": nil
        }
      },
      "varFields": [
        {
          "fieldTag": "a",
          "marcTag": "100",
          "ind1": "1",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "Elya, Susan Middleton,"
            },
            {
              "tag": "d",
              "content": "1955-"
            }
          ]
        },
        {
          "fieldTag": "b",
          "marcTag": "700",
          "ind1": "1",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "Guevara, Susan,"
            },
            {
              "tag": "e",
              "content": "ill."
            }
          ]
        },
        {
          "fieldTag": "c",
          "marcTag": "091",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "p",
              "content": "J"
            },
            {
              "tag": "a",
              "content": "398.2"
            },
            {
              "tag": "c",
              "content": "E"
            }
          ]
        },
        {
          "fieldTag": "d",
          "marcTag": "650",
          "ind1": " ",
          "ind2": "0",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "Bilingualism"
            },
            {
              "tag": "v",
              "content": "Juvenile fiction."
            }
          ]
        },
        {
          "fieldTag": "d",
          "marcTag": "655",
          "ind1": " ",
          "ind2": "7",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "Stories in rhyme."
            },
            {
              "tag": "2",
              "content": "lcgft"
            }
          ]
        },
        {
          "fieldTag": "d",
          "marcTag": "650",
          "ind1": " ",
          "ind2": "1",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "Fairy tales."
            }
          ]
        },
        {
          "fieldTag": "d",
          "marcTag": "650",
          "ind1": " ",
          "ind2": "1",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "Folklore."
            }
          ]
        },
        {
          "fieldTag": "i",
          "marcTag": "020",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "9780399247675 (hardcover)"
            }
          ]
        },
        {
          "fieldTag": "i",
          "marcTag": "020",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "039924767X (hardcover)"
            }
          ]
        },
        {
          "fieldTag": "l",
          "marcTag": "010",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "  2012022545"
            }
          ]
        },
        {
          "fieldTag": "l",
          "marcTag": "035",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "(OCoLC)799250948"
            },
            {
              "tag": "z",
              "content": "(OCoLC)875235489"
            }
          ]
        },
        {
          "fieldTag": "n",
          "marcTag": "500",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "The text is mostly English with some Spanish words."
            }
          ]
        },
        {
          "fieldTag": "n",
          "marcTag": "520",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "A rhyming twist on the classic fairy tale in which a little girl saves her grandmother from a wolf. Includes glossary of Spanish words."
            }
          ]
        },
        {
          "fieldTag": "o",
          "marcTag": "001",
          "ind1": " ",
          "ind2": " ",
          "content": "799250948",
          "subfields": nil
        },
        {
          "fieldTag": "p",
          "marcTag": "260",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "New York, NY :"
            },
            {
              "tag": "b",
              "content": "G. P. Putnam's Sons,"
            },
            {
              "tag": "c",
              "content": "2014."
            }
          ]
        },
        {
          "fieldTag": "q",
          "marcTag": "852",
          "ind1": "8",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "h",
              "content": "JFF 15-199"
            }
          ]
        },
        {
          "fieldTag": "r",
          "marcTag": "300",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "1 volume (unpaged) :"
            },
            {
              "tag": "b",
              "content": "color illustrations ;"
            },
            {
              "tag": "c",
              "content": "28 cm"
            }
          ]
        },
        {
          "fieldTag": "t",
          "marcTag": "245",
          "ind1": "1",
          "ind2": "0",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "Little Roja Riding Hood /"
            },
            {
              "tag": "c",
              "content": "Susan Middleton Elya ; illustrated by Susan Guevara."
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "003",
          "ind1": " ",
          "ind2": " ",
          "content": "OCoLC",
          "subfields": nil
        },
        {
          "fieldTag": "y",
          "marcTag": "005",
          "ind1": " ",
          "ind2": " ",
          "content": "20140415164127.0",
          "subfields": nil
        },
        {
          "fieldTag": "y",
          "marcTag": "008",
          "ind1": " ",
          "ind2": " ",
          "content": "120712s2014    nyua   j      000 0 eng  cam8a ",
          "subfields": nil
        },
        {
          "fieldTag": "y",
          "marcTag": "019",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "875235489"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "040",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "DLC"
            },
            {
              "tag": "b",
              "content": "eng"
            },
            {
              "tag": "c",
              "content": "DLC"
            },
            {
              "tag": "d",
              "content": "OCLCO"
            },
            {
              "tag": "d",
              "content": "YDXCP"
            },
            {
              "tag": "d",
              "content": "BTCTA"
            },
            {
              "tag": "d",
              "content": "OJ4"
            },
            {
              "tag": "d",
              "content": "NYP"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "042",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "lcac"
            },
            {
              "tag": "a",
              "content": "pcc"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "049",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "NYPP"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "050",
          "ind1": "0",
          "ind2": "0",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "PZ8.3.E514"
            },
            {
              "tag": "b",
              "content": "Lit 2013"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "082",
          "ind1": "0",
          "ind2": "0",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "398.2"
            },
            {
              "tag": "a",
              "content": "E"
            },
            {
              "tag": "2",
              "content": "23"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "901",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "sch "
            },
            {
              "tag": "b",
              "content": " CATRL"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "908",
          "ind1": "0",
          "ind2": "0",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "PZ8.3.E514"
            },
            {
              "tag": "b",
              "content": "Lit 2013"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "901",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "wch"
            },
            {
              "tag": "b",
              "content": "CATBL"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "901",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "MARS"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "945",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": ".b20054679x"
            }
          ]
        },
        {
          "fieldTag": "y",
          "marcTag": "946",
          "ind1": " ",
          "ind2": " ",
          "content": nil,
          "subfields": [
            {
              "tag": "a",
              "content": "m"
            }
          ]
        },
        {
          "fieldTag": "_",
          "marcTag": nil,
          "ind1": nil,
          "ind2": nil,
          "content": "00000cam  22004338a 4500",
          "subfields": nil
        }
      ]
    }
  ],
  "count": 1,
  "totalCount": 0,
  "statusCode": 200,
  "debugInfo": []
}

class Book < ActiveRecord::Base
  include CatalogItemMethods
  include Oauth
  has_paper_trail
  before_save :disable_papertrail
  before_update :enable_papertrail
  after_save :enable_papertrail

  attr_accessible :call_number, :cover_uri, :description, :details_url, :format, :id, :isbn, :notes, :physical_description, :primary_language, :publication_date, :statement_of_responsibility, :sub_title, :title, :catalog_choice, :bnumber
  attr_accessor :catalog_choice
  # attr_accessor :matching_api_items

	# has_and_belongs_to_many :authors
	has_many :teacher_set_books, :dependent => :destroy
	has_many :teacher_sets, through: :teacher_set_books

  # turn this off this obsolete validation so that we can run tests on book creation; otherwise you get this error: `Need to set ENVs`
  # validate do |book|
  #   BookValidator.new(book).validate
  # end

  # turn off this obsolete callback so that we can run tests on book creation; otherwise you get this error: `Need to set ENVs`
  # after_save :populate_missing_data
  after_commit :create_teacher_set_version_on_update, on: :update

  validates_uniqueness_of :bnumber, allow_blank: true

  def populate_missing_data
    if self.details_url.nil?
      puts "populate missing data for #{self.inspect}"
      if !self.catalog_choice.nil? && !self.catalog_choice.empty?
        # puts "populate missing data for #{self.inspect} from #{self.catalog_choice}"

        item = self.class.catalog_item self.catalog_choice
        # puts "item: ", item
        self.update_from_catalog_item item
        # puts "Success? ", item

      elsif !self.matching_api_items.nil? && self.matching_api_items.size == 1
        item = self.matching_api_items.first
        # puts "updating from item: #{item}"
        item = self.class.catalog_item item['id']
        # puts "updating from item item: #{item}"
        self.update_from_catalog_item item
      end
    end
  end

  def matching_api_items
    q = {}
    if !self.isbn.nil? && !self.isbn.empty?
      q[:isbn] = self.isbn

    else
      q[:title] = self.title
      q[:author] = self.statement_of_responsibility unless self.statement_of_responsibility.nil? || self.statement_of_responsibility.empty?
    end

    self.class.catalog_items_by_query q
  end

	def image_uri(size=:small)
    return nil if cover_uri.nil?

		deriv = 'S'
		deriv = 'M' if size == :medium
		deriv = 'L' if size == :large

		cover_uri.sub /Type=L/, "Type=#{deriv}"
	end

  def update_from_catalog_item(item)
		self.update_attributes :details_url => item['details_url']

		self.update_attributes :title => item['title'], :sub_title => item['sub_title'], :publication_date => item['publication_date'], :call_number => item['call_number'], :description => item['description'], :statement_of_responsibility => item['statement_of_responsibility']

		self.update_attributes :format => item['format']['name'] unless item['format'].nil?
		self.update_attributes :physical_description => item['physical_description'].join(';') unless item['physical_description'].nil?
		self.update_attributes :notes => item['notes'].join(';') unless item['notes'].nil?

		self.update_attributes :cover_uri => 'http://contentcafe2.btol.com/ContentCafe/Jacket.aspx?&userID=NYPL49807&password=CC68707&content=M&Return=1&Type=L&Value=' + item['isbns'].first unless item['isbns'].nil?
		self.update_attributes :isbn => item['isbns'].first if !item['isbns'].nil? && item['isbns'].size > 0
		self
  end

  def self.catalog_item(id)
    resp = self.api_call "titles/#{id}"
    # puts "cat item: #{resp.to_json}"
    return resp['title'] if resp.keys.include? 'title'
  end

  def self.catalog_item_by_query(q, scrape_fallback=false)
    res = self.catalog_items_by_query(q, scrape_fallback)
    res.first unless res.nil? || res.size == 0
  end

  def self.catalog_items_by_query(params, scrape_fallback=false)
    q = []
    # if !self.isbn.nil? && !self.isbn.empty?
    if !params[:isbn].nil?
      q << 'isbn:' + params[:isbn]
    else
      q << "title:(#{params[:title]})" unless params[:title].nil?
      q << "author:(#{params[:author]})" unless params[:author].nil? || params[:author].empty?
    end

    # puts "query: #{q.inspect}"

    resp = self.api_call 'titles', {:q => q.join(' '), :library => 'nypl', :search_type => 'custom'}

    if (!resp.keys.include?('titles') || resp['titles'].empty?) && scrape_fallback
      scrape_url = "http://#{CATALOG_DOMAIN}/search~S1/?searchtype=i&searcharg=#{params[:isbn]}"

      rows = self.scrape_css scrape_url, '.bibDetail tr', 1.day
      rows.each do |n|
        # puts " Considering row: #{n}"
        if (label = n.at_css('td.bibInfoLabel')) && label.text.strip.downcase == 'isbn'
          isbn = n.at_css('td.bibInfoData').text.strip.split(/ /).first
          puts "    Using alt isbn: #{isbn}"

          return self.catalog_items_by_query :isbn => isbn
        end
      end
    end

    return resp['titles'] if resp.keys.include? 'titles'

  end

  def self.update_by_catalog_id(id)
    item = self.catalog_item id
    Book.upsert_from_catalog_item item
  end

  def self.upsert_from_catalog_item(item)
		book = Book.find_or_initialize_by_details_url item['details_url']
    book.update_from_catalog_item item

    book
  end

  def create_teacher_set_version_on_update
    teacher_sets.all.each do |teacher_set|
      teacher_set.update_attributes(last_book_change: "updated-#{self.id}-#{self.title}")
    end
  end

  def update_from_isbn
    # response = send_request_to_bibs_microservice(isbn)
    response = EXAMPLE_RESPONSE_BODY_FROM_BIB_SERVICE
    book_attributes = response[:data][0]
    self.update_attributes(
      bnumber: book_attributes[:id],
      title: book_attributes[:title],
      publication_date: book_attributes[:publishYear],
      primary_language: (book_attributes[:lang] ? book_attributes[:lang][:name] : nil),
      details_url: "http://catalog.nypl.org/record=b#{book_attributes[:id]}~S1",
      call_number: var_field(book_attributes, '091'),
      description: var_field(book_attributes, '520'),
      physical_description: var_field(book_attributes, '300'),
      format: var_field(book_attributes, '020'),
      cover_uri: "http://contentcafe2.btol.com/ContentCafe/Jacket.aspx?&userID=NYPL49807&password=CC68707&content=M&Return=1&Type=L&Value=#{isbn}"
    )
  end

  private

  # Sends a request to the bibs microservice.
  def send_request_to_bibs_microservice(isbn)
    query = {
      'standardNumber' => isbn || '9782917623268'
    }
    LogWrapper.log('DEBUG',
      {
       'message' => 'Request sent to bibs service',
       'method' => 'send_request_to_bibs_microservice',
       'status' => 'start',
       'dataSent' => query
      })
    response = HTTParty.get(
      ENV['BIBS_MICROSERVICE_URL_V01'],
      body: query.to_json,
      headers:
        { 'Authorization' => "Bearer #{Oauth.get_oauth_token}",
          'Content-Type' => 'application/json' },
      timeout: 10
    )

    case response.code
    when 200
      LogWrapper.log('DEBUG',
        {
          'message' => "The bibs service responded with the book JSON.",
          'status' => response.code
        })
    else
      LogWrapper.log('ERROR',
        {
          'message' => "An error has occured when sending a request to the bibs service",
          'status' => response.code,
          'responseData' => response.body
        })
      raise Exceptions::InvalidResponse, "Invalid status code of: #{response.code}"
    end

    return response
  end

  def var_field(book_attributes, marcTag)
    begin
      book_attributes[:varFields].detect{ |hash| hash[:marcTag] == marcTag }[:subfields].map{ |x| x[:content]}.join(', ')
    rescue
      return nil
    end
  end
end
